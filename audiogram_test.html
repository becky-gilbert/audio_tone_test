<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Audiogram</title>
    <!-- <script src = "https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script> -->
    <script src = "jquery.min.js" type="text/javascript"></script>
    <script src = "jspsych-5.0.3/jspsych.js" type="text/javascript"></script>
    <script src = "jspsych-5.0.3/plugins/jspsych-instructions.js" type="text/javascript"></script>
    <script src = "jspsych-5.0.3/plugins/jspsych-single-audio-ends-trial.js" type="text/javascript"></script>
    <script src = "jspsych-5.0.3/plugins/jspsych-button-response.js"></script>
    <!-- <script src = "/jspsych-5.0.3/plugins/jspsych-text.js" type="text/javascript"></script> -->
    <script src = "jspsych-5.0.3/plugins/jspsych-single-stim.js" type="text/javascript"></script>
    <script src = "data/audiogram_trial_data.js" type="text/javascript"></script> 
    <!-- <script src = "/PapaParse-4.1.2/papaparse.min.js"></script> -->
    <link rel="stylesheet" type="text/css" href="jspsych-5.0.3/css/jspsych_BG_btn.css">
    <!-- <script src="/assets/javascripts/jatos.js"></script> -->
</head>
<body>
</body>
<script type="text/javascript">
//jatos.onLoad(function() {

    // get trial data from JATOS JSON input
    //var trial_obj = jatos.studyJsonInput[0].trial_data; // when running through JATOS
    // get trial data from javascript file audiogram_trial_data loaded in header
    //var trial_obj = trial_data_all[0].trial_data; // use this for old data structure (first in data object)
    var file_path = "audio/"; // change to var file_path = "/study_assets/"; when switching to JATOS
    var min_ITI = 2000; 
    var timeline = [];

    // add the JATOS properties to the data
    // jsPsych.data.addProperties({
    //     jatos_study_ID: jatos.studyId,
    //     jatos_component_ID: jatos.componentId,
    //     jatos_component_result_ID: jatos.componentResultId,
    //     jatos_result_ID_URL: jsPsych.data.getURLVariable('srid')
    // });

    // audiogram instructions - press button when you hear tone, otherwise do nothing
    var start_task = {
        type: 'instructions',
        pages: ['<p>You will hear a series of tones, presented at different levels and frequencies.<br><br>' + 
            'Whenever you hear a tone, press the "Tone" button.<br><br>We do not expect you to hear all the tones ' +
            '- some will be too quiet to hear, and if this is the case then you should NOT press the button.' + 
            '<br><br>This task will take a few minutes to complete.<br><br>' +
            'When you are ready, please press the "Next" button to start.</p>'],
        show_clickable_nav: true,
        timing_post_trial: 1000,
        data: {task_segment: 'instructions'}
    };
    timeline.push(start_task);

    // function for generating the stimulus HTML (HTML5 audio tag and prompt text) on each trial
    // this is called when the trials are created in a loop, with the iterator value as the argument
    function getAudioHtml(index) {
        var audio_file_name = [file_path, trial_data_all[index].trial_data.fileName].join("");
        htmlString = "<div><audio src='" + audio_file_name + "' autoplay></div><div><p>Press the button whenever you hear a tone.</p></div>";
        return htmlString;
    }

    // first 'button-response' trial is just to start the task, so that the participant knows where the button will be on the screen
    var trial_start = {
        type: 'button-response',
        is_html: true,
        choices: ['Start'],
        button_html: "<button class='jspsych-btn'>Start</button>", 
        timing_stim: -1,
        timing_response: -1,
        response_ends_trial: true,
        stimulus: "<div><p>Please press the 'Start' button to start.</p></div>",
        data: {task_segment: 'trial_start'}
    };
    timeline.push(trial_start);

    // silent trial to start the task - catch trial, and decouples 1st appearance of Tone button with 1st tone presentation
    // silent trial data is stored in trial_data_all[0]
    //var last_audio_index = trial_obj.length - 1; 
    var silent_trial_index = 0;
    var silent_trial = {
        type: 'button-response',
        is_html: true,
        choices: ['Tone'],
        button_html: "<button class='jspsych-btn'>Tone</button>", 
        timing_stim: min_ITI,
        timing_response: min_ITI,
        response_ends_trial: false,
        data: trial_data_all[silent_trial_index].trial_data,
        stimulus: [getAudioHtml(silent_trial_index)],
        timing_post_trial: 0,
        on_finish: function(data) {
            var response_type = "failed_catch";
            // -1 = no button press, didn't hear silent tone, correct, 0 = button pressed, heard silent tone, incorrect
            if (data.button_pressed == -1) { 
                response_type = "correct_miss";
            }
            jsPsych.data.addDataToLastTrial({response_type: response_type, trial_segment: 'audio_test_catch', task_segment: 'audio_test_main'}); 
        }
    };
    timeline.push(silent_trial);

    // for each set of tone frequencies: index 1 (first non-silent set) through end of trial_data_all array
    for (var i=1; i<trial_data_all.length; i++) {
        // create first block trial, with a function as the stimulus parameter, and loop this trial until tone not heard (miss)
        var trial_counter_1 = 0;
        var sound_number_1 = 0;
        var audio_trial_1 = {
            type: 'button-response',
            is_html: true,
            choices: ['Tone'],
            button_html: "<button class='jspsych-btn'>Tone</button>", 
            timing_stim: random_ITI,
            timing_response: min_ITI,
            response_ends_trial: false,
            stimulus: (function(){ 
                return getCurrentAudioHtmlDec(i);
                })(i),  // dynamic parameter
            timing_post_trial: 0,
            data: {
                frequency: trial_data_all[i].frequency,
                trial_segment: 'audio_test_response', 
                task_segment: 'audio_test_main',
                block_type: 'decreasing'
            }, 
            on_finish: (function(){ 
                return getDecOnFinish(i);
                })(i)
        };

        // loop node for first block (decreasing levels)
        var loop_node_1 = {
            timeline: [audio_trial_1],
            loop_function: function(data) {
                if (data[0].button_pressed == -1) {     // no button pressed, did not hear tone, end this loop
                    console.log("first missed sound, switch to block 2");
                    return false;
                } else {
                    return true;
                }
            }
        };
        // add loop node 1 to timeline
        timeline.push(loop_node_1);

        //var trial_counter_2 = trial_obj.length-1;
        //var sound_number_2 = trial_obj.length-1;
        var trial_counter_2 = trial_data_all[i].trial_data.length-1;
        var sound_number_2 = trial_data_all[i].trial_data.length-1;
        console.log("sound number 2 starting value: ", sound_number_2);
        var audio_trial_2 = {
            type: 'button-response',
            is_html: true,
            choices: ['Tone'],
            button_html: "<button class='jspsych-btn'>Tone</button>", 
            timing_stim: random_ITI,
            timing_response: min_ITI,
            response_ends_trial: false,
            stimulus: (function(){ 
                return getCurrentAudioHtmlInc(i);
                })(i),  // dynamic parameter
            timing_post_trial: 0,
            data: {
                frequency: trial_data_all[i].frequency,
                trial_segment: 'audio_test_response', 
                task_segment: 'audio_test_main',
                block_type: 'increasing'
            },
            on_finish: (function(){ 
                return getIncOnFinish(i);
                })(i)
        };

        // loop node for first block (decreasing levels)
        var loop_node_2 = {
            timeline: [audio_trial_2],
            loop_function: function(data) {
                if (data[0].button_pressed != -1) {     // button pressed, heard tone, end this loop
                    console.log("first heard sound, switch to next frequency or end task");
                    return false;
                } else {
                    return true;
                }
            }
        };
        // add loop node 2 to timeline
        timeline.push(loop_node_2);

    } // end frequency loop

    // get next audio HTML stimulus, decreasing by 10 dB
    function getCurrentAudioHtmlDec(i) {
        console.log("i is ", i);
        var currentAudioHtmlDec = function(sound_number_1) {
            //var audio_file_name = [file_path, trial_obj[sound_number_1].fileName].join("");
            var audio_file_name = [file_path, trial_data_all[i].trial_data[sound_number_1].fileName].join("");
            console.log("audio: ", audio_file_name);
            htmlString = "<div><audio src='" + audio_file_name + "' autoplay></div><div><p>Press the button whenever you hear a tone.</p></div>";
            return htmlString;
        };
        return function(){return currentAudioHtmlDec(sound_number_1);};
    }

    // get next audio HTML stimulus, increasing by 5 dB
    function getCurrentAudioHtmlInc(i) {
        console.log("i is ", i);
        var currentAudioHtmlInc = function(data, trial_counter_2, sound_number_2) {
            //var audio_file_name = [file_path, trial_obj[sound_number_2].fileName].join("");
            console.log("sound number 2: ", sound_number_2);
            var audio_file_name = [file_path, trial_data_all[i].trial_data[sound_number_2].fileName].join("");
            console.log("audio: ", audio_file_name);
            htmlString = "<div><audio src='" + audio_file_name + "' autoplay></div><div><p>Press the button whenever you hear a tone.</p></div>";
            return htmlString; 
        };
        return function(data){return currentAudioHtmlInc(data, trial_counter_2, sound_number_2);};
    }

    // on finish functions for the decreasing and increasing dB blocks
    function getDecOnFinish(i) {
        var decOnFinish = function(data) {
            var response_type = "miss";
            if (data.button_pressed === 0) { // 0 = 'Tone' button pressed, heard tone
                response_type = "hit";
            } 
            console.log("adding data to last trial");
            var data_to_add = $.extend({}, {response_type: response_type}, trial_data_all[i].trial_data[sound_number_1]);
            jsPsych.data.addDataToLastTrial(data_to_add);
            // jsPsych.data.addDataToLastTrial({
            //     response_type: response_type, 
            //     sound_number: trial_data_all[i].trial_data[sound_number_1].soundNumber
            // });
            // jsPsych.data.addDataToLastTrial(trial_data_all[i].trial_data[sound_number_1]);
            if (data.button_pressed === -1) { // -1 = no button pressed, switch blocks, change the value of sound_number_2 to the sound number of the last trial (1st missed tone)
                console.log("starting block 2 sound number: ", sound_number_2);
                var previous_data = jsPsych.data.getTrialsOfType('button-response');
                var last_sound_index = previous_data.length - 1; // assumes that the last saved data is the last trial from block 1 (first missed tone)
                console.log("last sound index: ", last_sound_index);
                //var last_sound_number = previous_data[last_sound_index].sound_number; 
                //console.log("last sound number: ",last_sound_number);
                sound_number_2 = previous_data[last_sound_index].soundNumber; 
                console.log("new starting block 2 sound number: ", sound_number_2);
            }
            // update the sound and trial numbers
            // first block, play every 2 sounds in decreasing order (10 dB difference)
            trial_counter_1+=1;
            if ((sound_number_1+2) < trial_data_all[i].trial_data.length) {
                sound_number_1+=2;
            }
            return sound_number_1;
        };
        return decOnFinish;
    }
    function getIncOnFinish(i) {
        var incOnFinish = function(data) {
            var response_type = "miss";
            if (data.button_pressed === 0) { // 0 = 'Tone' button pressed, heard tone
                response_type = "hit";
            } 
            console.log("adding data to last trial");
            var data_to_add = $.extend({}, {response_type: response_type}, trial_data_all[i].trial_data[sound_number_2]);
            jsPsych.data.addDataToLastTrial(data_to_add);
            // jsPsych.data.addDataToLastTrial({
            //     response_type: response_type, 
            // });
            // jsPsych.data.addDataToLastTrial(trial_data_all[i].trial_data[sound_number_2]);
            // update the sound and trial numbers
            // second block, so play every sound in increasing order (5 dB difference)
            trial_counter_2+=1;
            if ((sound_number_2-1) >= 0) {
                sound_number_2-=1;
            }
            return sound_number_2;
        };
        return incOnFinish;
    }

    // create the inter-trial intervals (this is created at start of task rather than evaluated on each trial because the evaluation slows the trial loading and causes white-screen gaps/flashes between trials)
    var random_ITI = function() {
        return Math.floor(Math.random()*500)+min_ITI;
    };

    // create experiment timeline
    //var timeline = [start_task, trial_start, silent_trial, loop_node_1, loop_node_2, silent_trial];

    // preload audio files manually (necessary because not playing the files with the jsPsych audio plugin), 
    // then start experiment when files are finished loading
    var sound_files = [];
    for (var freq_obj=0; freq_obj < trial_data_all.length; freq_obj++) {
        for (var trial=0; trial < trial_data_all[freq_obj].trial_data.length; trial++) {
            sound_files.push([file_path, trial_data_all[freq_obj].trial_data[trial].fileName].join(""));
            console.log("loading...");
        }
    }
    jsPsych.pluginAPI.preloadAudioFiles(sound_files, function(){startExperiment();}, function(){console.log("loading...");});

    function startExperiment() {
        jsPsych.init({
            timeline: timeline,
            fullscreen: true,
            default_iti: 0,
            show_progress_bar: false,
            on_finish: function() {
                jsPsych.data.displayData('json');
                //var resultJson = JSON.stringify(jsPsych.data.getData());
                //jatos.submitResultData(resultJson, jatos.startNextComponent);
            }
        });
    }
//});
</script>
</html>
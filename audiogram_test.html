<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Audiogram</title>
    <!-- <script src = "https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script> -->
    <script src = "jquery.min.js" type="text/javascript"></script>
    <script src = "jspsych-5.0.3/jspsych.js" type="text/javascript"></script>
    <script src = "jspsych-5.0.3/plugins/jspsych-instructions.js" type="text/javascript"></script>
    <script src = "jspsych-5.0.3/plugins/jspsych-single-audio-ends-trial.js" type="text/javascript"></script>
    <script src = "jspsych-5.0.3/plugins/jspsych-button-response.js"></script>
    <!-- <script src = "/jspsych-5.0.3/plugins/jspsych-text.js" type="text/javascript"></script> -->
    <script src = "jspsych-5.0.3/plugins/jspsych-single-stim.js" type="text/javascript"></script>
    <!-- <script src = "/PapaParse-4.1.2/papaparse.min.js"></script> -->
    <link rel="stylesheet" type="text/css" href="jspsych-5.0.3/css/jspsych.css">
    <!-- <script src="/assets/javascripts/jatos.js"></script> -->
</head>
<body>
</body>
<script type="text/javascript">
//jatos.onLoad(function() {

    // get trial data from JATOS JSON input
    //var trial_obj = jatos.studyJsonInput[0].trial_data; // when running through JATOS
    var trial_data_all = [{
        "frequency": "500", 
        "trial_data": [
        {
            "soundNumber": 1,
            "dbReduction": 0,
            "fileName": "500.mp3",
        },
        {
            "soundNumber": 2,
            "dbReduction": 5,
            "fileName": "500_5.mp3",
        },
        {
            "soundNumber": 3,
            "dbReduction": 10,
            "fileName": "500_10.mp3", 	 	
        },
        {
            "soundNumber": 4,
            "dbReduction": 15,
            "fileName": "500_15.mp3",
        },
        {
            "soundNumber": 5,
            "dbReduction": 20,
            "fileName": "500_20.mp3",
        },
        {
            "soundNumber": 6,
            "dbReduction": 25,
            "fileName": "500_25.mp3",
        },
        {
            "soundNumber": 7,
            "dbReduction": 30,
            "fileName": "500_30.mp3",
        },
        {
            "soundNumber": 8,
            "dbReduction": 35,
            "fileName": "500_35.mp3",
        },
        {
            "soundNumber": 9,
            "dbReduction": 40,
            "fileName": "500_40.mp3",
        },
        {
            "soundNumber": 10,
            "dbReduction": 45,
            "fileName": "500_45.mp3",
        },
        {
            "soundNumber": 11,
            "dbReduction": 50,
            "fileName": "500_50.mp3",
        },
        {
            "soundNumber": 12,
            "dbReduction": 55,
            "fileName": "500_55.mp3",
        },
        {
            "soundNumber": 13,
            "dbReduction": 60,
            "fileName": "500_60.mp3",
        },
        {
            "soundNumber": 14,
            "dbReduction": 65,
            "fileName": "500_65.mp3",
        },
        {
            "soundNumber": 15,
            "dbReduction": 70,
            "fileName": "500_70.mp3",
        },
        {
            "soundNumber": 16,
            "dbReduction": 75,
            "fileName": "500_75.mp3",
        },
        {
            "soundNumber": 17,
            "dbReduction": 80,
            "fileName": "500_80.mp3",
        },
        {
            "soundNumber": 18,
            "dbReduction": 85,
            "fileName": "500_85.mp3",
        },
        {
            "soundNumber": 19,
            "dbReduction": 90,
            "fileName": "500_90.mp3",
        },
        {
            "soundNumber": 20,
            "dbReduction": "NA",
            "fileName": "silence.mp3",
        }]
    }];

    var trial_obj = trial_data_all[0].trial_data;
    var file_path = "audio/"; // change to var file_path = "/study_assets/"; when switching to JATOS
    var min_ITI = 2000; 

    // add the JATOS properties to the data
    // jsPsych.data.addProperties({
    //     jatos_study_ID: jatos.studyId,
    //     jatos_component_ID: jatos.componentId,
    //     jatos_component_result_ID: jatos.componentResultId,
    //     jatos_result_ID_URL: jsPsych.data.getURLVariable('srid')
    // });

    // audiogram instructions - press button when you hear tone, otherwise do nothing
    var start_task = {
        type: 'instructions',
        pages: ['<p>You will hear a series of tones, presented at different levels and frequencies.<br><br>' + 
            'Whenever you hear a tone, press the "Tone" button.<br><br>We do not expect you to hear all the tones ' +
            '- some will be too quiet to hear, and if this is the case then you should NOT press the button.' + 
            '<br><br>This task will take a few minutes to complete.<br><br>' +
            'When you are ready, please press the "Next" button to start.</p>'],
        show_clickable_nav: true,
        timing_post_trial: 1000,
        data: {task_segment: 'instructions'}
    }

    // function for generating the stimulus HTML (HTML5 audio tag and prompt text) on each trial
    // this is called when the trials are created in a loop, with the iterator value as the argument
    function getAudioHtml(index) {
        var audio_file_name = [file_path, trial_obj[index].fileName].join("");
        htmlString = "<div><audio src='" + audio_file_name + "' autoplay></div><div><p>Press the button whenever you hear a tone.</p></div>";
        return htmlString;
    }

    // first 'button-response' trial is just to start the task, so that the participant knows where the button will be on the screen
    var trial_start = {
        type: 'button-response',
        is_html: true,
        choices: ['Start'],
        button_html: "<button class='jspsych-btn'>Start</button>", 
        timing_stim: -1,
        timing_response: -1,
        response_ends_trial: true,
        stimulus: "<div><p>Please press the 'Start' button to start.</p></div>",
        data: {task_segment: 'trial_start'}
    }

    // silent trial to start the task - catch trial, and decouples 1st appearance of Tone button with 1st tone presentation
    var last_audio_index = trial_obj.length - 1;
    var silent_trial = {
        type: 'button-response',
        is_html: true,
        choices: ['Tone'],
        button_html: "<button class='jspsych-btn'>Tone</button>", 
        timing_stim: min_ITI,
        timing_response: min_ITI,
        response_ends_trial: false,
        data: trial_obj[last_audio_index],
        stimulus: [getAudioHtml(last_audio_index)],
        timing_post_trial: 0,
        on_finish: function(data) {
            var response_type = "failed_catch";
            // -1 = no button press, didn't hear silent tone, correct, 0 = button pressed, heard silent tone, incorrect
            if (data.button_pressed == -1) { 
                response_type = "correct_miss";
            }
            jsPsych.data.addDataToLastTrial({response_type: response_type, trial_segment: 'audio_test_catch', task_segment: 'audio_test_main'}); 
        }
    }

    // create first block trial, with a function as the stimulus parameter, and loop this trial
    var trial_counter_1 = 0;
    var sound_number_1 = 0; 
    var audio_trial_1 = {
        type: 'button-response',
        is_html: true,
        choices: ['Tone'],
        button_html: "<button class='jspsych-btn'>Tone</button>", 
        timing_stim: random_ITI,
        timing_response: min_ITI,
        response_ends_trial: false,
        stimulus: getCurrentAudioHtmlDec,  // dynamic parameter
        timing_post_trial: 0,
        //data: getCurrentTrialData,      // dynamic parameter
        on_finish: function(data) {
            var response_type = "miss";
            if (data.button_pressed == 0) { // 0 = 'Tone' button pressed, heard tone
                response_type = "hit"
            } 
            jsPsych.data.addDataToLastTrial({response_type: response_type, 
                trial_segment: 'audio_test_response', 
                task_segment: 'audio_test_main'});
            jsPsych.data.addDataToLastTrial(trial_obj[sound_number_1]);
            // update the sound and trial numbers
            // first block, play every 2 sounds in decreasing order (10 dB difference)
            trial_counter_1+=1;
	        if ((sound_number_1+2) < trial_obj.length) {
	        	sound_number_1+=2;
	        }
        }
    }

    // loop node for first block (decreasing levels)
    var loop_node_1 = {
        timeline: [audio_trial_1],
        loop_function: function(data) {
            if (data[0].button_pressed == -1) {     // no button pressed, did not hear tone, end this loop
            	console.log("first missed sound number: ", sound_number_1);
                return false;
            } else {
                return true;
            }
        }
    }

    var trial_counter_2 = trial_obj.length-1;
    var sound_number_2 = trial_obj.length-1;
    var audio_trial_2 = {
        type: 'button-response',
        is_html: true,
        choices: ['Tone'],
        button_html: "<button class='jspsych-btn'>Tone</button>", 
        timing_stim: random_ITI,
        timing_response: min_ITI,
        response_ends_trial: false,
        stimulus: getCurrentAudioHtmlInc,  // dynamic parameter
        timing_post_trial: 0,
        //data: getCurrentTrialData,      // dynamic parameter
        on_finish: function(data) {
            var response_type = "miss";
            if (data.button_pressed == 0) { // 0 = 'Tone' button pressed, heard tone
                response_type = "hit"
            } 
            jsPsych.data.addDataToLastTrial({response_type: response_type, 
                trial_segment: 'audio_test_response', 
                task_segment: 'audio_test_main'});
            // store the data for this sound number in the current trial
    		jsPsych.data.addDataToLastTrial(trial_obj[sound_number_2]);
            // update the sound and trial numbers
            // second block, so play every sound in increasing order (5 dB difference)
            trial_counter_2+=1;
	        if ((sound_number_2-1) >= 0) {
	        	sound_number_2-=1;
	        }
        }
    }

    // loop node for first block (decreasing levels)
    var loop_node_2 = {
        timeline: [audio_trial_2],
        loop_function: function(data) {
            if (data[0].button_pressed != -1) {     // button pressed, heard tone, end this loop
            	console.log("first heard sound number: ", sound_number_2);
                return false;
            } else {
                return true;
            }
        }
    }

    // NOTE: need to pass through the data object to check if this is the last level (silent) and check for the last sound level that was responded to 
    // get next audio HTML decreasing by 10 dB
    function getCurrentAudioHtmlDec() {
        var audio_file_name = [file_path, trial_obj[sound_number_1].fileName].join("");
        htmlString = "<div><audio src='" + audio_file_name + "' autoplay></div><div><p>Press the button whenever you hear a tone.</p></div>";
        return htmlString;
    }

    // get next audio HTML increasing by 5 dB
    function getCurrentAudioHtmlInc() {
    	// 2nd block, so start at the last level that was missed in 1st block
    	if (trial_counter_2 == trial_obj.length-1) { // first trial in this block
    		var previous_data = jsPsych.data.getTrialsOfType('button-response');
    		var last_sound_index = previous_data.length - 2; // last trial is a silent catch trial, so we want the one before that
    		var last_sound_number = previous_data[last_sound_index].soundNumber;
    		sound_number_2 = last_sound_number-1; // because the indexing for sound numbers starts at 0
    		console.log("first missed sound number (get audio function): ", sound_number_2);
    	}
        var audio_file_name = [file_path, trial_obj[sound_number_2].fileName].join("");
        htmlString = "<div><audio src='" + audio_file_name + "' autoplay></div><div><p>Press the button whenever you hear a tone.</p></div>";
        return htmlString;
    }

    // create the inter-trial intervals (this is created at start of task rather than evaluated on each trial because the evaluation slows the trial loading and causes white-screen gaps/flashes between trials)
    var random_ITI = function() {
    	return Math.floor(Math.random()*500)+min_ITI;
    }

    // create experiment timeline
    var timeline = [start_task, trial_start, silent_trial, loop_node_1, loop_node_2, silent_trial];

    // preload audio files manually (necessary because not playing the files with the jsPsych audio plugin), 
    // then start experiment when files are finished loading
    var sound_files = [];
    for (var trial of trial_data_all[0].trial_data) {
        sound_files.push([file_path, trial.fileName].join(""));
        console.log("loading...");
    }
    jsPsych.pluginAPI.preloadAudioFiles(sound_files, function(){startExperiment();});

    function startExperiment() {
        jsPsych.init({
            timeline: timeline,
            fullscreen: true,
            default_iti: 0,
            show_progress_bar: false,
            on_finish: function() {
                jsPsych.data.displayData('json');
                //var resultJson = JSON.stringify(jsPsych.data.getData());
                //jatos.submitResultData(resultJson, jatos.startNextComponent);
            }
        });
    }
//});
</script>
</html>